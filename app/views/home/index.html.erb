<%
  # Define colors for top 6 resources
  resource_colors = [
    { bg: '#e74c3c', text: 'white', name: 'Crimson' },
    { bg: '#f39c12', text: 'white', name: 'Orange' },
    { bg: '#27ae60', text: 'white', name: 'Emerald' },
    { bg: '#3498db', text: 'white', name: 'Blue' },
    { bg: '#9b59b6', text: 'white', name: 'Purple' },
    { bg: '#1abc9c', text: 'white', name: 'Teal' }
  ]
%>

<% if @map || @top_external.any? %>
  <%# Pills for Internal/External toggle %>
  <div class="bg-dark py-2">
    <div class="container-fluid px-4">
      <ul class="nav nav-pills justify-content-center" id="resourceTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active px-4" id="internal-tab" data-bs-toggle="pill" data-bs-target="#internal-panel" type="button" role="tab">
            <i class="bi bi-building"></i> Internal
            <% if @top_internal.any? %>
              <span class="badge bg-light text-dark ms-1"><%= @top_internal.count %></span>
            <% end %>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link px-4" id="external-tab" data-bs-toggle="pill" data-bs-target="#external-panel" type="button" role="tab">
            <i class="bi bi-geo-alt"></i> External
            <% if @top_external.any? %>
              <span class="badge bg-light text-dark ms-1"><%= @top_external.count %></span>
            <% end %>
          </button>
        </li>
      </ul>
    </div>
  </div>

  <div class="tab-content">
    <%# INTERNAL TAB %>
    <div class="tab-pane fade show active" id="internal-panel" role="tabpanel">
      <% if @map %>
        <%# Top Internal Resources bar %>
        <% if @top_internal.any? %>
          <div class="bg-dark py-3 border-top border-secondary">
            <div class="container-fluid px-4">
              <div class="row g-2 justify-content-center">
                <% @top_internal.each_with_index do |resource, idx| %>
                  <% color = resource_colors[idx] %>
                  <div class="col-6 col-md-4 col-lg-2">
                    <%= link_to resource_path(resource), class: "text-decoration-none" do %>
                      <div class="d-flex align-items-center p-2 rounded bg-dark bg-opacity-50 border border-secondary h-100 resource-card">
                        <span class="badge rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                              style="width: 32px; height: 32px; background: <%= color[:bg] %>; color: <%= color[:text] %>; font-size: 14px; font-weight: bold;">
                          <%= idx + 1 %>
                        </span>
                        <div class="flex-grow-1 min-width-0">
                          <div class="text-white fw-medium text-truncate" style="font-size: 0.9rem;">
                            <% if resource.icon.present? %>
                              <% if resource.icon.start_with?('bi-') %>
                                <i class="bi <%= resource.icon %> me-1"></i>
                              <% else %>
                                <span class="me-1"><%= resource.icon %></span>
                              <% end %>
                            <% end %>
                            <%= resource.name %>
                          </div>
                          <small class="text-secondary"><%= pluralize(resource.view_count, 'view') %></small>
                        </div>
                      </div>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>

        <%# Facility Map %>
        <div class="position-relative" style="height: calc(100vh - <%= @top_internal.any? ? '160px' : '100px' %>); overflow: hidden;">
          <% if @map.image.attached? %>
            <div class="w-100 h-100 d-flex align-items-center justify-content-center bg-dark position-relative" id="internal-map-container">
              <div class="position-relative" style="max-height: 100%; max-width: 100%;">
                <%= image_tag @map.image, class: "img-fluid", style: "max-height: calc(100vh - #{@top_internal.any? ? '160px' : '100px'}); max-width: 100%; object-fit: contain;", id: "main-map-image" %>
                
                <%# Markers for top resources %>
                <% @top_internal.each_with_index do |resource, idx| %>
                  <% color = resource_colors[idx] %>
                  <% resource.resource_locations.where(map_id: @map.id).each do |location| %>
                    <%= link_to resource_path(resource), 
                        class: "position-absolute text-decoration-none", 
                        style: "left: #{location.x}%; top: #{location.y}%; transform: translate(-50%, -50%); z-index: 10;",
                        title: "#{resource.name} (#{resource.view_count} views)" do %>
                      <div class="d-flex align-items-center justify-content-center"
                           style="width: 32px; height: 32px; background: <%= color[:bg] %>; border: 3px solid white; border-radius: 50%; box-shadow: 0 3px 8px rgba(0,0,0,0.4); color: <%= color[:text] %>; font-weight: bold; font-size: 14px;">
                        <%= idx + 1 %>
                      </div>
                    <% end %>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="d-flex align-items-center justify-content-center h-100 bg-dark">
              <div class="text-center text-muted">
                <i class="bi bi-map" style="font-size: 4rem;"></i>
                <p class="mt-3">No image uploaded for this map yet.</p>
                <% if current_user&.admin? || (current_user && @map.maintainer?(current_user)) %>
                  <%= link_to "Upload Image", edit_map_path(@map), class: "btn btn-primary" %>
                <% end %>
              </div>
            </div>
          <% end %>
          
          <%# Map info badge %>
          <div class="position-absolute bottom-0 start-0 p-3">
            <div class="bg-dark bg-opacity-75 text-white rounded px-3 py-2">
              <strong><%= @map.name %></strong>
              <%= link_to "View Details", @map, class: "btn btn-sm btn-outline-light ms-2" %>
            </div>
          </div>
        </div>
      <% else %>
        <div class="d-flex align-items-center justify-content-center bg-dark" style="height: calc(100vh - 100px);">
          <div class="text-center text-muted">
            <i class="bi bi-map" style="font-size: 4rem;"></i>
            <p class="mt-3 text-light">No default map has been set.</p>
            <% if current_user&.admin? %>
              <p class="text-secondary small">As an admin, you can set a default map by editing any map.</p>
            <% end %>
            <%= link_to "Browse Maps", maps_path, class: "btn btn-outline-light" %>
          </div>
        </div>
      <% end %>
    </div>

    <%# EXTERNAL TAB %>
    <div class="tab-pane fade" id="external-panel" role="tabpanel">
      <%# Top External Resources bar %>
      <% if @top_external.any? %>
        <div class="bg-dark py-3 border-top border-secondary">
          <div class="container-fluid px-4">
            <div class="row g-2 justify-content-center">
              <% @top_external.each_with_index do |resource, idx| %>
                <% color = resource_colors[idx] %>
                <div class="col-6 col-md-4 col-lg-2">
                  <%= link_to resource_path(resource), class: "text-decoration-none" do %>
                    <div class="d-flex align-items-center p-2 rounded bg-dark bg-opacity-50 border border-secondary h-100 resource-card">
                      <span class="badge rounded-circle d-flex align-items-center justify-content-center me-2 flex-shrink-0" 
                            style="width: 32px; height: 32px; background: <%= color[:bg] %>; color: <%= color[:text] %>; font-size: 14px; font-weight: bold;">
                        <%= idx + 1 %>
                      </span>
                      <div class="flex-grow-1 min-width-0">
                        <div class="text-white fw-medium text-truncate" style="font-size: 0.9rem;">
                          <% if resource.icon.present? %>
                            <% if resource.icon.start_with?('bi-') %>
                              <i class="bi <%= resource.icon %> me-1"></i>
                            <% else %>
                              <span class="me-1"><%= resource.icon %></span>
                            <% end %>
                          <% end %>
                          <%= resource.name %>
                        </div>
                        <small class="text-secondary"><%= pluralize(resource.view_count, 'view') %></small>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        
        <%# OpenStreetMap %>
        <div id="external-osm-map" style="height: calc(100vh - 160px);"></div>
        
        <!-- Leaflet for OSM -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        
        <script>
          var externalMapInitialized = false;
          
          document.getElementById('external-tab').addEventListener('shown.bs.tab', function() {
            if (externalMapInitialized) return;
            externalMapInitialized = true;
            
            var colors = ['#e74c3c', '#f39c12', '#27ae60', '#3498db', '#9b59b6', '#1abc9c'];
            
            <% if @site_config.has_location? %>
            var homeLat = <%= @site_config.latitude %>;
            var homeLng = <%= @site_config.longitude %>;
            var homeName = "<%= j(@site_config.organization_name.presence || 'Our Location') %>";
            <% else %>
            var homeLat = 45.5155;
            var homeLng = -122.6793;
            var homeName = "Portland, OR";
            <% end %>
            
            var map = L.map('external-osm-map').setView([homeLat, homeLng], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              maxZoom: 19,
              attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);
            
            // Home marker
            <% if @site_config.has_location? %>
            var homeIcon = L.divIcon({
              className: 'home-marker',
              html: '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 36px; height: 36px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 8px rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; color: white; font-size: 18px;">' +
                    '<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">' +
                    '<path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4z"/>' +
                    '</svg></div>',
              iconSize: [36, 36],
              iconAnchor: [18, 18]
            });
            L.marker([homeLat, homeLng], { icon: homeIcon })
              .addTo(map)
              .bindPopup('<strong>üè† ' + homeName + '</strong><br><small>Our Location</small>');
            <% end %>
            
            // Resource markers
            var markers = [];
            <% @top_external.each_with_index do |resource, idx| %>
              <% resource.resource_external_locations.limit(1).each do |loc| %>
              (function() {
                var color = colors[<%= idx %>];
                var icon = L.divIcon({
                  className: 'resource-marker',
                  html: '<div style="background: ' + color + '; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;"><%= idx + 1 %></div>',
                  iconSize: [28, 28],
                  iconAnchor: [14, 14]
                });
                var marker = L.marker([<%= loc.latitude %>, <%= loc.longitude %>], { icon: icon })
                  .addTo(map)
                  .bindPopup('<strong><%= j(resource.name) %></strong><br><small><%= pluralize(resource.view_count, 'view') %></small>');
                markers.push(marker);
              })();
              <% end %>
            <% end %>
            
            // Fit bounds to show all markers
            if (markers.length > 0) {
              <% if @site_config.has_location? %>
              markers.push(L.marker([homeLat, homeLng]));
              <% end %>
              var group = L.featureGroup(markers);
              map.fitBounds(group.getBounds().pad(0.1));
            }
          });
        </script>
      <% else %>
        <div class="d-flex align-items-center justify-content-center bg-dark" style="height: calc(100vh - 100px);">
          <div class="text-center text-muted">
            <i class="bi bi-geo-alt" style="font-size: 4rem;"></i>
            <p class="mt-3 text-light">No external resources with locations yet.</p>
            <%= link_to "Browse Resources", resources_path, class: "btn btn-outline-light" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <style>
    .min-width-0 { min-width: 0; }
    .resource-card:hover {
      background: rgba(255, 255, 255, 0.1) !important;
      border-color: rgba(255, 255, 255, 0.3) !important;
    }
    #resourceTabs .nav-link {
      color: rgba(255, 255, 255, 0.7);
    }
    #resourceTabs .nav-link:hover {
      color: rgba(255, 255, 255, 0.9);
    }
    #resourceTabs .nav-link.active {
      background-color: #0d6efd;
      color: white;
    }
  </style>
<% else %>
  <div class="container mt-5">
    <div class="text-center">
      <i class="bi bi-map" style="font-size: 5rem; color: #6c757d;"></i>
      <h2 class="mt-4">Welcome to Geowiki</h2>
      <p class="text-muted">No default map has been set and no external resources are available.</p>
      <% if current_user %>
        <%= link_to "Browse Maps", maps_path, class: "btn btn-primary" %>
        <% if current_user.admin? %>
          <p class="mt-3 text-muted small">As an admin, you can set a default map by editing any map.</p>
        <% end %>
      <% else %>
        <%= link_to "Browse Maps", maps_path, class: "btn btn-primary" %>
        <%= link_to "Login", login_path, class: "btn btn-outline-secondary ms-2" %>
      <% end %>
    </div>
  </div>
<% end %>
