<!DOCTYPE html>
<html data-bs-theme="light">
  <head>
    <title>Geowiki</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>

    <!-- RSS Feed -->
    <%= auto_discovery_link_tag :rss, feed_resources_url(format: :rss), title: "Geowiki Resources RSS Feed" %>

    <!-- Bootstrap 5.3.8 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Dark mode detection - runs early to prevent flash -->
    <script>
      (function() {
        const getPreferredTheme = () => {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        };
        
        document.documentElement.setAttribute('data-bs-theme', getPreferredTheme());
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
          document.documentElement.setAttribute('data-bs-theme', e.matches ? 'dark' : 'light');
        });
      })();
    </script>

    <style>
      /* Custom dark mode overrides */
      [data-bs-theme="dark"] {
        --bs-body-bg: #1a1d21;
        --bs-card-bg: #212529;
      }
      
      [data-bs-theme="dark"] .card {
        background-color: var(--bs-card-bg);
        border-color: #373b3e;
      }
      
      [data-bs-theme="dark"] .table {
        --bs-table-bg: transparent;
      }
      
      [data-bs-theme="dark"] .navbar {
        background-color: #0d0f10 !important;
      }
      
      [data-bs-theme="dark"] .form-control,
      [data-bs-theme="dark"] .form-select {
        background-color: #2b3035;
        border-color: #495057;
        color: #e9ecef;
      }
      
      [data-bs-theme="dark"] .form-control:focus,
      [data-bs-theme="dark"] .form-select:focus {
        background-color: #2b3035;
        border-color: #86b7fe;
        color: #e9ecef;
      }
      
      [data-bs-theme="dark"] .form-control::placeholder {
        color: #6c757d;
      }
      
      [data-bs-theme="dark"] .list-group-item {
        background-color: var(--bs-card-bg);
        border-color: #373b3e;
      }
      
      [data-bs-theme="dark"] .border,
      [data-bs-theme="dark"] .border-bottom {
        border-color: #373b3e !important;
      }
      
      [data-bs-theme="dark"] .bg-light {
        background-color: #2b3035 !important;
      }
      
      [data-bs-theme="dark"] .text-muted {
        color: #9ca3af !important;
      }
      
      [data-bs-theme="dark"] .btn-outline-secondary {
        color: #adb5bd;
        border-color: #6c757d;
      }
      
      [data-bs-theme="dark"] .btn-outline-secondary:hover {
        color: #fff;
        background-color: #6c757d;
      }
      
      [data-bs-theme="dark"] .dropdown-menu {
        background-color: #212529;
        border-color: #373b3e;
      }
      
      [data-bs-theme="dark"] .dropdown-item {
        color: #e9ecef;
      }
      
      [data-bs-theme="dark"] .dropdown-item:hover {
        background-color: #2b3035;
      }

      /* Leaflet map dark mode */
      [data-bs-theme="dark"] .leaflet-container {
        background: #1a1d21;
      }
      
      [data-bs-theme="dark"] .leaflet-popup-content-wrapper,
      [data-bs-theme="dark"] .leaflet-popup-tip {
        background: #212529;
        color: #e9ecef;
      }
      
      [data-bs-theme="dark"] .leaflet-control-zoom a {
        background: #212529;
        color: #e9ecef;
        border-color: #373b3e;
      }
      
      [data-bs-theme="dark"] .leaflet-control-zoom a:hover {
        background: #2b3035;
      }
      
      [data-bs-theme="dark"] .leaflet-control-attribution {
        background: rgba(33, 37, 41, 0.8);
        color: #9ca3af;
      }
      
      [data-bs-theme="dark"] .leaflet-control-attribution a {
        color: #6ea8fe;
      }
    </style>
  </head>

  <body>
    <nav class="navbar navbar-expand-lg" data-bs-theme="dark">
      <div class="container">
        <%= link_to "Geowiki", root_path, class: "navbar-brand" %>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto">
            <li class="nav-item">
              <%= link_to "Maps", maps_path, class: "nav-link" %>
            </li>
            <li class="nav-item">
              <%= link_to "Resources", resources_path, class: "nav-link" %>
            </li>
            <% if current_user %>
              <li class="nav-item">
                <%= link_to new_resource_path, class: "nav-link", title: "Add Resource" do %>
                  <i class="bi bi-plus-circle"></i> Resource
                <% end %>
              </li>
            <% end %>
          </ul>
          <ul class="navbar-nav">
            <% if current_user %>
              <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                  <i class="bi bi-person-circle"></i>
                  <%= current_user.name || current_user.email %>
                  <% if current_user.admin? %>
                    <span class="badge bg-danger">Admin</span>
                  <% end %>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                  <% if current_user.admin? %>
                    <li><%= link_to journal_path, class: "dropdown-item" do %><i class="bi bi-journal-text"></i> Activity Journal<% end %></li>
                    <li><%= link_to edit_site_config_path, class: "dropdown-item" do %><i class="bi bi-gear"></i> Site Config<% end %></li>
                    <li><hr class="dropdown-divider"></li>
                  <% end %>
                  <li><%= link_to "Logout", logout_path, class: "dropdown-item" %></li>
                </ul>
              </li>
            <% else %>
              <li class="nav-item">
                <%= link_to "Login", login_path, class: "nav-link" %>
              </li>
            <% end %>
          </ul>
        </div>
      </div>
    </nav>

    <% if flash[:notice] %>
      <div class="container mt-3">
        <div class="alert alert-success alert-dismissible fade show" role="alert">
          <%= flash[:notice] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
    <% end %>

    <% if flash[:alert] %>
      <div class="container mt-3">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
          <%= flash[:alert] %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      </div>
    <% end %>

    <%= yield %>

    <!-- Bootstrap 5.3.8 JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  </body>
</html>
